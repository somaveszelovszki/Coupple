Date.prototype.toMySQLDatetimeString=function(){this.setHours(this.getHours()-this.getTimezoneOffset()/60);return this.toISOString().substring(0,19).replace("T"," ")};Date.prototype.add=function(b,a){switch(a.toLowerCase()){case"day":case"days":this.setDate(this.getDate()+b);break;case"millisecond":case"milliseconds":this.setMilliseconds(this.getMilliseconds()+b);break;case"year":case"years":this.setFullYear(this.getFullYear()+b);break}return this};Storage.prototype.setObject=function(b,a){this.setItem(b,JSON.stringify(a))};Storage.prototype.getObject=function(c){var b=JSON.parse(this.getItem(c));var a=/[\d]{4}-[\d]{2}-[\d]{2}T[\d]{2}:[\d]{2}:[\d]{2}.[\d]{3}Z/;for(var c in b){if(typeof b[c]==="string"&&a.test(b[c])){b[c]=new Date(b[c])}}return b};Array.prototype.removeMatchingValues=function(c){for(var b=0;b<this.length;b++){for(var a=0;a<c.length;a++){if(this[b]===c[a]){this.splice(b--,1);break}}}return this};function createURIText(a){return car.baseUrl+"index.php?/"+a.replace(/index\.php(\?)?/,"").replace(car.baseUrl,"")}function dateDifference(c,a,b){b=b!=undefined?b:true;if(b&&a<c){a.setFullYear(c.getFullYear()+1)}return parseInt(Math.ceil((a-c)/1000/60/60/24),10)}function isEmpty(a){if(a==""||a==null||a=="undefined"){return true}if(typeof a==="object"){return a.length==0}if(a==="datetime"){return false}return false}function hasEmptyValue(b,a){a=a!=undefined?a:true;if(isEmpty(b)){return true}if(typeof b=="object"){for(var c in b){if(isEmpty(b[c])){return true}if(a&&typeof b[c]=="object"&&hasEmptyValue(b[c],true)){return true}}}return false}function fillObjectWithTrash(a){if(typeof a=="object"){for(var b in a){a[b]=fillObjectWithTrash(a[b])}}else{a="someData"}return a}Array.prototype.getMax=function(b,c){if(isEmpty(this)){return null}c=!isEmpty(c)?c.toLowerCase():"number";var a=Math.max.apply(null,this.map(function(d){switch(c){case"number":case"integer":return d[b];case"datetime":case"date":case"time":return new Date(d[b])}}));switch(c){case"number":case"integer":return a;case"datetime":case"date":case"time":return new Date(a)}};var messagesUpdater={createMessagesObjectForSessionStorage:function(){var a={};a.activeMessages=[];a.lastMessageDateTime=null;a.initializeLimit=20;a.unreadMessages=[];return a},setUnreadMessagesUpdateFrequency:function(c){var a=sessionStorage.getObject("couple");if(isEmpty(a)){return}if(false){var b=new Date().toMySQLDatetimeString();$.post(createURIText("coupple/ajaxCreate/messages"),{data:{text:Math.random()*10,dateTime:b,coupleId:a.id,fromId:a.accessId,toId:(a.accessId==="couple")?1:a.accessId},time:b},function(d){if(d.success){}else{console.log(d.message?d.message:"Some error has happened during saving message :(")}},"json")}messagesUpdater.updateUnreadMessages();setTimeout(function(){messagesUpdater.setUnreadMessagesUpdateFrequency(c)},c)},updateUnreadMessages:function(b){b=!isEmpty(b)?b:false;var a=sessionStorage.getObject("couple");if(isEmpty(a)){return}var c=new Date().toMySQLDatetimeString();$.post(createURIText("coupple/ajaxSearch/messages"),{data:{toId:a.accessId!="couple"?a.persons[a.accessId].id:null,unread:1},time:c},function(d){if(d.success){if(d.result){var e=sessionStorage.getObject("messages");e=isEmpty(e)?messagesUpdater.createMessagesObjectForSessionStorage():e;if(d.result.length>0){console.log("unread: "+d.result.length);e.unreadMessages=d.result;sessionStorage.setObject("messages",e)}else{console.log("No messages found")}if(car.isMessagesTabOpen&&(b||e.unreadMessages.length)){messagesUpdater.updateMessagesArea(b)}else{messagesUpdater.updateNewMessageIndicator(e.unreadMessages.length)}}else{console.log("Some error has happened :(")}}else{console.log(d.message?d.message:"Some error has happened :(")}},"json")},updateMessagesArea:function(c){c=!isEmpty(c)?c:false;var a=sessionStorage.getObject("couple");if(isEmpty(a)){return}var b=sessionStorage.getObject("messages");b=isEmpty(b)?messagesUpdater.createMessagesObjectForSessionStorage():b;var e=isEmpty(b.unreadMessages)?0:b.unreadMessages.length;var d=new Date().toMySQLDatetimeString();$.post(createURIText("coupple/ajaxSearch/messages"),{data:{limit:b.activeMessages.length?"no":Math.max(b.initializeLimit,e),minDateTime:!isEmpty(b.lastMessageDateTime)?b.lastMessageDateTime.toMySQLDatetimeString():null},time:d},function(f){if(f.success){if(f.result){f.result=f.result.removeMatchingValues(b.activeMessages);b.activeMessages=b.activeMessages.concat(f.result);var h=$("#pastMessagesArea");if(h){var m=h.scrollTop()+h.height()===h[0].scrollHeight;f.result.forEach(g);if(m||c){h.scrollTop(h[0].scrollHeight)}}function g(n){var o=a.accessId==="couple"?a.person1Id:a.accessId;var i='										<div id="message'+n.id+'" class="messageRow">											<div class="messageBox '+((n.fromId===o)?"sent":"received")+'"><span class="name">'+a.persons[n.fromId].firstName+'</span>										<div class="messageTextBox">											<span>'+n.text+"</span>									</div>								</div>							</div>";h.append(i)}b.lastMessageDateTime=b.activeMessages.getMax("dateTime","datetime");b.unreadMessages=[];sessionStorage.setObject("messages",b);if(!isEmpty(f.result)&&!isEmpty(f.result.length)&&f.result.length>0){var k=[];for(var j=0;j<f.result.length;j++){k.push(f.result[j].id)}var l=new Date().toMySQLDatetimeString();$.post(createURIText("coupple/ajaxUpdate/messages"),{criteria:{id:k},data:{unread:0},time:l},function(i){if(i.success){if(i.result){}else{console.log("Some error has happened :(")}}else{console.log(i.message?i.message:"Some error has happened :(")}},"json")}}else{console.log("Some error has happened :(")}}else{console.log(f.message?f.message:"Some error has happened during :(")}},"json")},updateNewMessageIndicator:function(a){if(!a){return}$("#topMenuBar>#messages span.badge").removeClass("noDisplay").text(a)}};$(document).ready(function(){var a=new Date();$(".datepicker").pickadate({selectMonths:true,selectYears:120,min:new Date(a.getFullYear()-120,0,1),max:a});$("textarea.autoHeight").on("input recalculateHeight",function(){var b=parseInt($(this).css("padding-top"));var c=parseInt($(this).css("padding-bottom"));if(this.scrollHeight<b+this.style.height+c){this.style.height="0px"}this.style.height=(this.scrollHeight-c-b)+"px"});messagesUpdater.setUnreadMessagesUpdateFrequency(5000)});